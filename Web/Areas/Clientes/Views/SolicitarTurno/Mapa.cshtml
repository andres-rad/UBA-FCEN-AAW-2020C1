@using Aplicacion.UseCases.Cliente
@using Newtonsoft.Json
@model List<ListarTurneroMapaDTO>
<style>
    .hidden {
        display:none;
    }
</style>

<div id="buscarTurneroMap" style="height:400px"></div>

<div id="buscarTurneroDataPanel" class="hidden">
    <h1><label id="descripcionTurnero"></label><br /></h1>
    <h3><label id="direccionTurnero"></label></h3>
    <a href="#" id="confirmarTurneroLink" class="btn btn-primary" role="button">Pedir turno</a>
</div>



<script src="https://openlayers.org/api/OpenLayers.js"></script>

<script>
    /////////////////////////////////////////////////////////
    // FACTORIZAR
    var zoom = 12;
    var latIni = -34.6302673;
    var lonIni = -58.4356537;
    var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
    var positionIni = new OpenLayers.LonLat(lonIni, latIni).transform(fromProjection, toProjection);

    map = new OpenLayers.Map("buscarTurneroMap");
    var mapnik = new OpenLayers.Layer.OSM();
    map.addLayer(mapnik);

    map.setCenter(positionIni, zoom);
    /////////////////////////////////////////////////////////


    var markers = new OpenLayers.Layer.Markers("Markers");
    map.addLayer(markers);

    var buildAddress = (idTurnero) => `@Url.Link("Default", new { Area = "Clientes",  Controller = "SolicitarTurno", Action = "ConfirmarTurno"})/?idTurnero=${idTurnero}`
    var turneros = @Html.Raw(@JsonConvert.SerializeObject(Model))



    function cargar(id, concepto, direccion, lat, lon) {
        var position = new OpenLayers.LonLat(lon, lat).transform(fromProjection, toProjection);

        var marker = new OpenLayers.Marker(position);
        marker.id = id;
        marker.icon.imageDiv.title = concepto;

        marker.events.register("click", marker, function () {
            console.log(`Click en  turnero ${id}: ${concepto}`)
            $("#descripcionTurnero").text(concepto);
            $("#direccionTurnero").text(direccion);
            $("#idTurnero").val(id);

            
            $("#confirmarTurneroLink").attr("href", buildAddress(id) );

            $("#buscarTurneroDataPanel").removeClass('hidden');
        });
        markers.addMarker(marker);
        }

    for (var turnero of turneros) {
        var direccion = `${turnero.Calle} ${turnero.Numero}${turnero.Ciudad}`;
        cargar(turnero.Id, turnero.Concepto, direccion, turnero.Ubicacion.Latitud, turnero.Ubicacion.Longitud);
    }
</script>
@*@foreach (var turnero in Model)
{
    <script> cargar(@turnero.Id, "@turnero.Concepto", parseFloat("@turnero.Ubicacion.Latitud".replace(',', '.')), parseFloat("@turnero.Ubicacion.Longitud".replace(',', '.')))</script>
}*@